---
- include_tasks: user_setup.yml

- set_fact:
    nginx_config_dir: "{{ nginx.home }}/config"

- assert:
    that:
      - nginx_config_dir is defined
      - nginx_config_dir != ""
    quiet: true
    fail_msg: "Invalid parameters"

- stat:
    path: "{{ nginx_config_dir }}"
  register: nginx_config_dir_path

- assert:
    that:
      - nginx_config_dir_path is defined

- file:
    state: directory
    path: "{{ nginx_config_dir }}"
    owner: "{{ nginx.username }}"
    group: "{{ nginx.groupname }}"
  when:
    - not nginx_config_dir_path.stat.exists

- include_tasks: nginx_config.yml

- include_tasks: static_content.yml

- include_tasks: http_cache_setup.yml
  when: nginx.caches is defined

- include_tasks: ssl.yml
  when: nginx.https is defined

- include_tasks: jenkins.yml
  when:
    - jenkins is defined
    - jenkins.service is defined

- name: permit traffic in default zone for https service
  firewalld:
    service: "{{ item }}"
    permanent: yes
    state: enabled
  loop:
    - http
    - https


- set_fact:
    podman_services: "{{ podman_services }} + {{ nginx.service }}"
